<!DOCTYPE html>
<html lang="en" class="dark">

<head>
  <meta charset="UTF-8">
  <meta name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>Zenith â€¢ Sovereign Ledger</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: { gold: '#d4af37', obsidian: '#0a0a0b', card: '#121214' },
          fontFamily: { display: ['Plus Jakarta Sans', 'sans-serif'], sans: ['Inter', 'sans-serif'] }
        }
      }
    }
  </script>

  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Plus+Jakarta+Sans:wght@700;800&display=swap"
    rel="stylesheet">

  <style>
    body {
      background-color: #0a0a0b;
      color: #e4e4e7;
      margin: 0;
      overflow: hidden;
    }

    #splash-screen {
      position: fixed;
      inset: 0;
      background: #0a0a0b;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      transition: opacity 0.5s ease;
    }

    .splash-logo {
      width: 64px;
      height: 64px;
      background: #d4af37;
      border-radius: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 24px;
      box-shadow: 0 0 40px rgba(212, 175, 55, 0.2);
      animation: pulse 2s infinite ease-in-out;
    }

    @keyframes pulse {

      0%,
      100% {
        transform: scale(1);
      }

      50% {
        transform: scale(1.1);
      }
    }

    .splash-text {
      font-family: 'Plus Jakarta Sans', sans-serif;
      font-size: 10px;
      font-weight: 800;
      color: #3f3f46;
      text-transform: uppercase;
      letter-spacing: 0.5em;
      text-align: center;
    }

    #api-gate {
      position: fixed;
      inset: 0;
      background: rgba(10, 10, 11, 0.98);
      backdrop-filter: blur(20px);
      z-index: 10000;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .loader-error {
      color: #ef4444 !important;
      font-size: 8px !important;
      margin-top: 10px;
    }
  </style>

  <script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@19.2.3",
    "react-dom": "https://esm.sh/react-dom@19.2.3",
    "react-dom/client": "https://esm.sh/react-dom@19.2.3/client",
    "recharts": "https://esm.sh/recharts@3.6.0",
    "idb-keyval": "https://esm.sh/idb-keyval@6.2.2",
    "jspdf": "https://esm.sh/jspdf@3.0.4",
    "xlsx": "https://esm.sh/xlsx@0.18.5",
    "jspdf-autotable": "https://esm.sh/jspdf-autotable@5.0.2",
    "@google/genai": "https://esm.sh/@google/genai@1.34.0",
    "react-dom/": "https://esm.sh/react-dom@^19.2.3/",
    "react/": "https://esm.sh/react@^19.2.3/",
    "express": "https://esm.sh/express@^5.2.1",
    "pg": "https://esm.sh/pg@^8.16.3",
    "cors": "https://esm.sh/cors@^2.8.5",
    "vite": "https://esm.sh/vite@^7.3.0",
    "@vitejs/plugin-react": "https://esm.sh/@vitejs/plugin-react@^5.1.2"
  }
}
</script>
</head>

<body>
  <div id="splash-screen">
    <div class="splash-logo">
      <svg width="32" height="32" viewBox="0 0 100 100" fill="none">
        <path d="M50 20L85 80H15L50 20Z" fill="#0a0a0b" />
      </svg>
    </div>
    <div id="loader-status" class="splash-text">Initialising Core...</div>
    <div id="error-log" class="splash-text loader-error"></div>
  </div>

  <!-- Mandatory API Key Gate -->
  <div id="api-gate">
    <div class="max-w-md w-full p-8 md:p-10 bg-zinc-900 border border-white/5 rounded-[2.5rem] text-center shadow-2xl">
      <div class="w-16 h-16 bg-gold/10 rounded-2xl flex items-center justify-center mx-auto mb-6">
        <i class="fa-solid fa-key text-gold text-2xl"></i>
      </div>
      <h2 class="font-display font-bold text-xl text-white mb-2">Authorize Access</h2>
      <p class="text-zinc-500 text-[11px] mb-8 leading-relaxed">This ledger uses <b>Gemini 3 Pro</b> for
        institutional-grade financial intelligence. A paid API key from a Google Cloud Project is required.</p>
      <button id="btn-select-key"
        class="w-full py-4 bg-gold text-obsidian font-black rounded-2xl text-[10px] uppercase tracking-[0.3em] hover:brightness-110 active:scale-95 transition-all">
        Connect Ledger Key
      </button>
      <a href="https://ai.google.dev/gemini-api/docs/billing" target="_blank"
        class="block mt-6 text-[9px] text-zinc-600 uppercase font-bold tracking-widest hover:text-zinc-400 underline decoration-gold/30 underline-offset-4">Billing
        Documentation</a>
    </div>
  </div>

  <div id="root"></div>

  <script type="text/javascript">
    // Manual Loader Logic to bypass GitHub Pages .tsx MIME issue
    async function loadAndTranspile(url) {
      const response = await fetch(url);
      if (!response.ok) throw new Error(`Fetch failed for ${url}`);
      const text = await response.text();

      // Use Babel to transpile .tsx to standard JS
      const result = Babel.transform(text, {
        presets: ['react', ['typescript', { isTSX: true, allExtensions: true }]],
        filename: url,
        plugins: [
          // Minimal plugin to rewrite .tsx imports in-flight
          ({ types: t }) => ({
            visitor: {
              ImportDeclaration(path) {
                if (path.node.source.value.endsWith('.tsx')) {
                  // We keep the .tsx extension but the loader will handle it
                }
              }
            }
          })
        ]
      });

      return result.code;
    }

    async function bootSystem() {
      const status = document.getElementById('loader-status');
      const errorLog = document.getElementById('error-log');

      try {
        // 1. Mandatory Key Check
        if (window.aistudio && typeof window.aistudio.hasSelectedApiKey === 'function') {
          const hasKey = await window.aistudio.hasSelectedApiKey();
          if (!hasKey) {
            document.getElementById('api-gate').style.display = 'flex';
            document.getElementById('btn-select-key').onclick = async () => {
              await window.aistudio.openSelectKey();
              location.reload();
            };
            return;
          }
        }

        status.innerText = "Synchronizing Ledger...";

        // Load the entry point
        const code = await loadAndTranspile('./index.tsx');

        // Inject as a module script
        const blob = new Blob([code], { type: 'text/javascript' });
        const url = URL.createObjectURL(blob);
        const script = document.createElement('script');
        script.type = 'module';
        script.src = url;
        document.body.appendChild(script);

        status.innerText = "Access Granted";
      } catch (err) {
        console.error("Critical Boot Error:", err);
        status.innerText = "BOOT FAILURE";
        errorLog.innerText = err.message + "\nCheck browser console.";
      }
    }

    window.addEventListener('DOMContentLoaded', bootSystem);
  </script>
</body>

</html>